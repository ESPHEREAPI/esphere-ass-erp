<!-- Breadcrumb -->
<div breadcrumb>
  <ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="#">{{ 'common.home' | translate }}</a></li>
    <li class="breadcrumb-item active">{{ 'dashboard.title' | translate }}</li>
  </ol>
  <h1 class="m-0">{{ 'dashboard.title' | translate }}</h1>
</div>

<!-- Filtre de période -->
<div class="row mb-3">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body">
        <div class="btn-group" role="group">
          <button
            type="button"
            class="btn btn-sm"
            [class.btn-primary]="selectedPeriod === 'jour'"
            [class.btn-outline-primary]="selectedPeriod !== 'jour'"
            (click)="changePeriod('jour')"
          >
            {{ 'dashboard.period.day' | translate }}
          </button>
          <button
            type="button"
            class="btn btn-sm"
            [class.btn-primary]="selectedPeriod === 'semaine'"
            [class.btn-outline-primary]="selectedPeriod !== 'semaine'"
            (click)="changePeriod('semaine')"
          >
            {{ 'dashboard.period.week' | translate }}
          </button>
          <button
            type="button"
            class="btn btn-sm"
            [class.btn-primary]="selectedPeriod === 'mois'"
            [class.btn-outline-primary]="selectedPeriod !== 'mois'"
            (click)="changePeriod('mois')"
          >
            {{ 'dashboard.period.month' | translate }}
          </button>
          <button
            type="button"
            class="btn btn-sm"
            [class.btn-primary]="selectedPeriod === 'annee'"
            [class.btn-outline-primary]="selectedPeriod !== 'annee'"
            (click)="changePeriod('annee')"
          >
            {{ 'dashboard.period.year' | translate }}
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            (click)="toggleCustomDateRange()"
          >
            {{ 'dashboard.period.custom' | translate }}
          </button>
        </div>

        <!-- Filtre de dates personnalisées -->
        <div *ngIf="customDateRange" class="mt-3">
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label>{{ 'common.from' | translate }}</label>
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="dateDebut"
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>{{ 'common.to' | translate }}</label>
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="dateFin"
                />
              </div>
            </div>
            <div class="col-md-4">
              <label>&nbsp;</label>
              <button
                class="btn btn-primary btn-block"
                (click)="applyCustomDateFilter()"
                [disabled]="!dateDebut || !dateFin"
              >
                {{ 'common.filter' | translate }}
              </button>
            </div>
          </div>
        </div>

        <button class="btn btn-sm btn-default float-right" (click)="refresh()">
          <i class="fas fa-sync-alt"></i> {{ 'common.refresh' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading spinner -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">{{ 'common.loading' | translate }}</span>
  </div>
</div>

<!-- Dashboard content -->
<div *ngIf="!loading && consommationGlobale">
  <!-- Small boxes (Stat box) -->
  <div class="row">
    <div class="col-lg-3 col-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ formatCurrency(consommationGlobale.totalDepenses) }}</h3>
          <p>{{ 'dashboard.total_consumption' | translate }}</p>
        </div>
        <div class="icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <a href="#" class="small-box-footer">
          <span *ngIf="consommationGlobale.evolution">
            <i class="fas"
               [class.fa-arrow-up]="consommationGlobale.evolution.sens === 'hausse'"
               [class.fa-arrow-down]="consommationGlobale.evolution.sens === 'baisse'">
            </i>
            {{ consommationGlobale.evolution.pourcentage }}%
          </span>
        </a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ formatCurrency(consommationGlobale.totalRembourse) }}</h3>
          <p>{{ 'dashboard.total_reimbursed' | translate }}</p>
        </div>
        <div class="icon">
          <i class="fas fa-hand-holding-usd"></i>
        </div>
        <a href="#" class="small-box-footer">
          {{ consommationGlobale.tauxRemboursementMoyen }}% {{ 'common.average' | translate }}
        </a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ formatCurrency(consommationGlobale.totalACharge) }}</h3>
          <p>{{ 'dashboard.total_to_pay' | translate }}</p>
        </div>
        <div class="icon">
          <i class="fas fa-wallet"></i>
        </div>
        <a href="#" class="small-box-footer">&nbsp;</a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ consommationGlobale.nombreConsultations }}</h3>
          <p>{{ 'dashboard.consultations_count' | translate }}</p>
        </div>
        <div class="icon">
          <i class="fas fa-hospital"></i>
        </div>
        <a href="#" class="small-box-footer">&nbsp;</a>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row">
    <!-- Graphique par période -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ 'dashboard.statistics_by_period' | translate }}</h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div style="height: 300px;">
            <canvas
              *ngIf="periodChartData"
              baseChart
              [data]="periodChartData"
              [options]="periodChartOptions"
              [type]="periodChartType"
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphique par prestation -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ 'dashboard.statistics_by_service' | translate }}</h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div style="height: 300px;">
            <canvas
              *ngIf="prestationChartData"
              baseChart
              [data]="prestationChartData"
              [options]="prestationChartOptions"
              [type]="prestationChartType"
            ></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertes et Top Prestataires -->
  <div class="row">
    <!-- Alertes -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ 'dashboard.alerts' | translate }}</h3>
          <span class="badge badge-danger float-right">{{ alertes.length }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped">
              <tbody>
                <tr *ngFor="let alerte of alertes.slice(0, 5)">
                  <td style="width: 10px">
                    <i [class]="getAlertIcon(alerte.type)" [class.text-danger]="alerte.severite === 'critical'"></i>
                  </td>
                  <td>
                    <strong>{{ alerte.titre }}</strong><br>
                    <small class="text-muted">{{ alerte.message }}</small>
                  </td>
                  <td style="width: 40px">
                    <button
                      class="btn btn-sm btn-outline-primary"
                      (click)="markAlerteAsViewed(alerte)"
                      *ngIf="alerte.statut === 'nouvelle'"
                    >
                      <i class="fas fa-check"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="alertes.length === 0">
                  <td colspan="3" class="text-center text-muted">
                    {{ 'common.no_data' | translate }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer clearfix" *ngIf="alertes.length > 5">
          <a [routerLink]="['/notifications']" class="btn btn-sm btn-info float-right">
            {{ 'common.view_all' | translate }}
          </a>
        </div>
      </div>
    </div>

    <!-- Top Prestataires -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ 'dashboard.top_providers' | translate }}</h3>
        </div>
        <div class="card-body p-0">
          <ul class="products-list product-list-in-card pl-2 pr-2">
            <li class="item" *ngFor="let prestataire of dashboardStats?.topPrestataires?.slice(0, 5); let i = index">
              <div class="product-info">
                <span class="badge badge-primary">{{ i + 1 }}</span>
                <a href="javascript:void(0)" class="product-title ml-2">
                  {{ prestataire.nomPrestataire }}
                  <span class="badge badge-info float-right">{{ prestataire.nombreActes }} {{ 'common.acts' | translate }}</span>
                </a>
                <span class="product-description">
                  {{ formatCurrency(prestataire.montantTotal) }}
                </span>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message si aucune donnée -->
<div *ngIf="!loading && !consommationGlobale" class="text-center py-5">
  <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
  <p class="text-muted">{{ 'common.no_data' | translate }}</p>
</div>
