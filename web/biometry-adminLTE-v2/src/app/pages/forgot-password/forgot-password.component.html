<body class="login-page">
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isLoading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text">{{ loadingMessage | translate }}...</p>
            <div class="progress-bar-container">
                <div class="progress-bar" [style.width.%]="loadingProgress"></div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-custom navbar-fixed-top">
        <div class="container">
            <div class="navbar-header navbar">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand"><b>ZENITHE Insurance</b></a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown" [ngClass]="{'open': isOpen}">
                        <a role="button" class="dropdown-toggle" (click)="toggleDropdown()">
                            Language: {{ currentLanguage.name }} <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li *ngFor="let lang of languages">
                                <a role="button" (click)="selectLanguage(lang)"
                                    [class.active]="lang.code === currentLanguage.code">
                                    {{ lang.name }}
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Forgot Password Form -->
    <div class="container">
        <div class="login-box">
            <div class="login-logo text-center">
                <a><b class="brand-main">ZENITHE </b>
                    <span class="brand-sub">Insurance</span></a>
            </div>

            <div class="login-box-body card">
                <!-- Success Message -->
                <div *ngIf="successMessage" class="alert alert-success alert-dismissible">
                    <button type="button" class="close" (click)="successMessage = ''">×</button>
                    <i class="fa fa-check"></i> {{ successMessage }}
                </div>

                <!-- Error Message -->
                <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" (click)="errorMessage = ''">×</button>
                    <i class="fa fa-exclamation-triangle"></i> {{ errorMessage }}
                </div>

                <p class="login-box-msg text-center">
                    <i class="fa fa-lock" style="font-size: 40px; color: #3c8dbc; margin-bottom: 10px;"></i><br>
                    <strong>{{"resetPassword" | translate}}</strong>
                </p>
                <p class="text-muted text-center small" style="margin-bottom: 20px;">
                    {{"resetPasswordInstructions" | translate}}
                </p>

                <form [formGroup]="forgotPasswordForm" (ngSubmit)="onSubmit()">
                    <!-- Choix du mode de récupération -->
                    <div class="form-group">
                        <label>{{"recoveryMethod" | translate}}</label>
                        <div class="radio">
                            <label>
                                <input type="radio" formControlName="recoveryMethod" value="email">
                                <i class="fa fa-envelope"></i> {{"email" | translate}}
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" formControlName="recoveryMethod" value="phone">
                                <i class="fa fa-phone"></i> {{"phone" | translate}}
                            </label>
                        </div>
                    </div>

                    <!-- Champ Email (si méthode email) -->
                    <div class="form-group has-feedback" *ngIf="recoveryMethod === 'email'">
                        <input type="email" formControlName="email" class="form-control"
                            placeholder="{{'emailAddress' | translate}}" />
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                        <div *ngIf="f['email'].touched && f['email'].invalid" class="text-danger small">
                            <div *ngIf="f['email'].errors?.['required']">{{'email' | translate}} is required</div>
                            <div *ngIf="f['email'].errors?.['email']">Invalid email format</div>
                        </div>
                    </div>

                    <!-- Champ Téléphone (si méthode téléphone) -->
                    <div class="form-group has-feedback" *ngIf="recoveryMethod === 'phone'">
                        <input type="tel" formControlName="phone" class="form-control"
                            placeholder="{{'phoneNumber' | translate}}" />
                        <span class="glyphicon glyphicon-phone form-control-feedback"></span>
                        <div *ngIf="f['phone'].touched && f['phone'].invalid" class="text-danger small">
                            <div *ngIf="f['phone'].errors?.['required']">{{'phone' | translate}} is required</div>
                            <div *ngIf="f['phone'].errors?.['pattern']">Invalid phone format</div>
                        </div>
                    </div>

                    <!-- Section Code de sécurité (apparaît après demande) -->
                    <div *ngIf="codeSent">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            {{"securityCodeSent" | translate}} <strong>{{ recoveryMethod === 'email' ? f['email'].value
                                : f['phone'].value }}</strong>
                        </div>

                        <!-- Code de sécurité -->
                        <div class="form-group has-feedback">
                            <input type="text" formControlName="securityCode" class="form-control"
                                placeholder="{{'securityCode' | translate}}" maxlength="6" />
                            <span class="glyphicon glyphicon-lock form-control-feedback"></span>
                            <div *ngIf="f['securityCode'].touched && f['securityCode'].invalid"
                                class="text-danger small">
                                <div *ngIf="f['securityCode'].errors?.['required']">{{'securityCode' | translate}} is
                                    required</div>
                                <div *ngIf="f['securityCode'].errors?.['minlength']">Code must be 6 characters</div>
                            </div>
                        </div>

                        <!-- Nouveau mot de passe -->
                        <div class="form-group has-feedback position-relative">
                            <input [type]="showPassword ? 'text' : 'password'" formControlName="newPassword"
                                class="form-control" placeholder="{{'newPassword' | translate}}"
                                (input)="checkPasswordStrength(f['newPassword'].value)" />
                            <span class="glyphicon glyphicon-lock form-control-feedback"></span>

                            <!-- Bouton œil -->
                            <span class="toggle-password " (click)="showPassword = !showPassword">
                                <i class="fa" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                            </span>

                            <!-- Messages erreurs classiques -->
                            <div *ngIf="f['newPassword'].touched && f['newPassword'].invalid" class="text-danger small">
                                <div *ngIf="f['newPassword'].errors?.['required']">{{'newPassword' | translate}} is
                                    required</div>
                                <div *ngIf="f['newPassword'].errors?.['minlength']">Minimum 8 characters</div>
                            </div>

                            <!-- Critères dynamiques -->
                            <ul class="password-requirements small">
                                <li [class.text-success]="passwordCriteria.minLength"
                                    [class.text-danger]="!passwordCriteria.minLength">
                                    {{ 'passwordRequirements.minLength' | translate }}
                                </li>
                                <li [class.text-success]="passwordCriteria.upperCase"
                                    [class.text-danger]="!passwordCriteria.upperCase">
                                    {{ 'passwordRequirements.upperCase' | translate }}
                                </li>
                                <li [class.text-success]="passwordCriteria.lowerCase"
                                    [class.text-danger]="!passwordCriteria.lowerCase">
                                    {{ 'passwordRequirements.lowerCase' | translate }}
                                </li>
                                <li [class.text-success]="passwordCriteria.number"
                                    [class.text-danger]="!passwordCriteria.number">
                                    {{ 'passwordRequirements.number' | translate }}
                                </li>
                                <li [class.text-success]="passwordCriteria.specialChar"
                                    [class.text-danger]="!passwordCriteria.specialChar">
                                    {{ 'passwordRequirements.specialChar' | translate }}
                                </li>
                            </ul>
                        </div>

                        <!-- Confirmer mot de passe -->
                        <div class="form-group has-feedback position-relative">
                            <input [type]="showConfirmPassword ? 'text' : 'password'" formControlName="confirmPassword"
                                class="form-control" placeholder="{{'confirmPassword' | translate}}" />
                            <span class="glyphicon glyphicon-lock form-control-feedback"></span>

                            <!-- Bouton œil -->
                            <span class="toggle-password" (click)="showConfirmPassword = !showConfirmPassword">
                                <i class="fa" [ngClass]="showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                            </span>

                            <div *ngIf="f['confirmPassword'].touched && f['confirmPassword'].invalid"
                                class="text-danger small">
                                <div *ngIf="f['confirmPassword'].errors?.['required']">{{'confirmPassword' | translate}}
                                    is required</div>
                            </div>
                            <div *ngIf="forgotPasswordForm.errors?.['passwordMismatch'] && f['confirmPassword'].touched"
                                class="text-danger small">
                                Passwords do not match
                            </div>
                        </div>

                    </div>

                    <!-- Boutons -->
                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-primary btn-flat btn-block"
                            [disabled]="isFormInvalid() || isLoading">
                            <span *ngIf="!isLoading">
                                <i class="fa" [ngClass]="codeSent ? 'fa-check' : 'fa-paper-plane'"></i>
                                {{ codeSent ? ('resetPassword' | translate) : ('sendCode' | translate) }}
                            </span>
                            <span *ngIf="isLoading">
                                <i class="fa fa-spinner fa-spin"></i> {{'processing' | translate}}...
                            </span>
                        </button>
                    </div>

                    <!-- Lien retour -->
                    <div class="text-center">
                        <a [routerLink]="['/login']" class="forgot-password-link">
                            <i class="fa fa-arrow-left"></i> {{"backToLogin" | translate}}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <div class="pull-right hidden-xs">
                <b>Version</b> {{appVersion}}
            </div>
            <p>&copy; 2018-{{currentYear}} <b><a href="https://zenitheinsurance.com" target="_blank">ZENITHE
                        Insurance</a></b>. Tous droits réservés.</p>
            <p class="small">Conçu avec ❤️ par l'équipe IT</p>
        </div>
    </footer>
</body>