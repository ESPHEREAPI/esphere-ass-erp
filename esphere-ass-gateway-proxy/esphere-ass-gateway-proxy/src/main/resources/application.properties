# Configuration Gateway
spring.application.name=gateway-proxy
server.port=8080

# Connexion au Config Server (d\u00e9sactiv\u00e9 car on utilise les propri\u00e9t\u00e9s locales)
# spring.config.import=optional:configserver:http://config-server:9101

# Connexion \u00e0 Eureka
eureka.client.service-url.defaultZone=http://eureka-server:8761/eureka/
eureka.instance.lease-renewal-interval-in-seconds=10
eureka.instance.hostname=gateway-proxy
eureka.instance.prefer-ip-address=false

# IMPORTANT: D\u00e9sactiver le discovery locator pour \u00e9viter les conflits
spring.cloud.gateway.discovery.locator.enabled=false

# ===== CONFIGURATION SSL POUR APPELS SORTANTS =====
spring.cloud.gateway.httpclient.ssl.use-insecure-trust-manager=true

# ===== CONFIGURATION CORS =====
spring.cloud.gateway.default-filters[0]=DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials Access-Control-Allow-Methods Access-Control-Allow-Headers, RETAIN_UNIQUE

spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origin-patterns=http://localhost:*,http://127.0.0.1:*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=Authorization,Content-Type,Accept,X-Requested-With,Cache-Control,Pragma
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].exposed-headers=Authorization,Content-Type,Accept
spring.cloud.gateway.globalcors.cors-configurations.[/**].max-age=3600

# ===== CONFIGURATION DES ROUTES =====

# Route 0: Microservice Biometrie - Utiliser lb:// pour Eureka
spring.cloud.gateway.routes[0].id=microservice-biometrie
spring.cloud.gateway.routes[0].uri=lb://SERVICE-BIOMETRIE
spring.cloud.gateway.routes[0].predicates[0]=Path=/gateway-proxy/api/service-biometrie/**
spring.cloud.gateway.routes[0].filters[0]=StripPrefix=3
spring.cloud.gateway.routes[0].filters[1]=PreserveHostHeader
spring.cloud.gateway.routes[0].filters[2]=DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
spring.cloud.gateway.routes[0].metadata.response-timeout=180000
spring.cloud.gateway.routes[0].metadata.connect-timeout=5000

# Route 1: Microservice Admin
spring.cloud.gateway.routes[1].id=esphere-ass-microservice-admin
spring.cloud.gateway.routes[1].uri=lb://ESPHERE-ASS-MICROSERVICE-ADMIN
spring.cloud.gateway.routes[1].predicates[0]=Path=/gateway-proxy/api/esphere-ass-microservice-admin/**
spring.cloud.gateway.routes[1].filters[0]=StripPrefix=3
spring.cloud.gateway.routes[1].filters[1]=PreserveHostHeader
spring.cloud.gateway.routes[1].filters[2]=DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE

# Route 2: Microservice Biometrie Partenaire - CORRECTION ICI
spring.cloud.gateway.routes[2].id=service-biometrie-partenaire
spring.cloud.gateway.routes[2].uri=lb://BIOMETRIE-PARTENAIRE
spring.cloud.gateway.routes[2].predicates[0]=Path=/gateway-proxy/api/service-biometrie-partenaire/**
spring.cloud.gateway.routes[2].filters[0]=StripPrefix=3
spring.cloud.gateway.routes[2].filters[1]=PreserveHostHeader
spring.cloud.gateway.routes[2].filters[2]=DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE

# Route 3: Microservice Service Zenbio
spring.cloud.gateway.routes[3].id=service-zenbio
spring.cloud.gateway.routes[3].uri=lb://SERVICE-ZENBIO
spring.cloud.gateway.routes[3].predicates[0]=Path=/gateway-proxy/api/service-zenbio/**
spring.cloud.gateway.routes[3].filters[0]=StripPrefix=3
spring.cloud.gateway.routes[3].filters[1]=PreserveHostHeader
spring.cloud.gateway.routes[3].filters[2]=DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE

# ===== CONFIGURATION PERFORMANCE ET TIMEOUTS =====
spring.cloud.gateway.httpclient.connect-timeout=30000
spring.cloud.gateway.httpclient.response-timeout=60s
spring.cloud.gateway.httpclient.pool.max-idle-time=400s
spring.cloud.gateway.httpclient.pool.max-life-time=90s
spring.cloud.gateway.httpclient.pool.type=ELASTIC
spring.cloud.gateway.httpclient.pool.max-connections=500

# ===== MONITORING =====
management.endpoints.web.exposure.include=gateway,health,info,refresh
management.endpoint.gateway.enabled=true

# ===== LOGGING =====
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.reactor.netty.http.client=DEBUG
logging.level.org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping=DEBUG
logging.level.org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator=DEBUG
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# Logs d\u00e9taill\u00e9s pour le routing
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.reactor.netty.http.client=DEBUG
logging.level.org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping=DEBUG
logging.level.org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator=DEBUG

# \u2b50 AJOUTER CES LIGNES IMPORTANTES
logging.level.org.springframework.cloud.gateway.filter=DEBUG
logging.level.org.springframework.cloud.loadbalancer=DEBUG
logging.level.reactor.netty=DEBUG
logging.level.org.springframework.web.reactive=DEBUG