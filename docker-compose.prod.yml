services:
  # Configuration Server
  config-server:
    build:
      context: ./esphere-ass-config-serveur/esphere-ass-config-serveur
      dockerfile: Dockerfile
    container_name: config-server
    ports:
      - "8888:9101"
    environment:
      - SPRING_PROFILES_ACTIVE=native
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "powershell", "-Command", "try { $response = Invoke-WebRequest -Uri http://localhost:9101/actuator/health -UseBasicParsing; exit 0 } catch { exit 1 }"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Eureka Server
  eureka-server:
    build:
      context: ./esphere-ass-eureka-server/esphere-ass-eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      config-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "powershell", "-Command", "try { $response = Invoke-WebRequest -Uri http://localhost:8761/actuator/health -UseBasicParsing; exit 0 } catch { exit 1 }"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # API Gateway
  gateway-proxy:
    build:
      context: ./esphere-ass-gateway-proxy/esphere-ass-gateway-proxy
      dockerfile: Dockerfile
    container_name: gateway-proxy
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # Service biometrie
  biometry:
    build:
      context: ./biometrie/biometry
      dockerfile: Dockerfile
    container_name: biometry
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/biometry?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=DeepWater@2021DeepWater@2021
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # Biométrie Partenaire
  biometrie-partenaire:
    build:
      context: ./biometry-partenaire/biometry
      dockerfile: Dockerfile
    container_name: biometrie-partenaire
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/biometry?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # Admin Service (Oracle 11g distant sur 77.68.94.193)
  esphere-ass-microservice-admin:
    build:
      context: ./esphere-ass-administration-apio/esphere-ass-administration-api
      dockerfile: Dockerfile
    container_name: esphere-ass-microservice-admin
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:oracle:thin:@77.68.94.193:1521:ZINSDB
      - SPRING_DATASOURCE_USERNAME=ORASSADM
      - SPRING_DATASOURCE_PASSWORD=zen5000tech
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=oracle.jdbc.OracleDriver
      - SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT=30000
      - SPRING_DATASOURCE_HIKARI_VALIDATION_TIMEOUT=5000
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=10
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # Frontend Angular 18
  frontend:
    build:
      context: ./web/espace-souscripteur-frontend/zenithe-biometrie/zenithe-biometrie-espace-client
      dockerfile: Dockerfile
    container_name: frontend-angular
    ports:
      - "8000:8080"
    depends_on:
      - gateway-proxy
    networks:
      - microservices-network
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # Frontend Biometry
  frontend-biometry:
    build:
      context: ./web/biometry-adminLTE-v2
      dockerfile: Dockerfile
    container_name: frontend-biometry
    ports:
      - "8180:8080"
    depends_on:
      - gateway-proxy
    networks:
      - microservices-network
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # Frontend Esphere ASS
  frontend-esphere-ass:
    build:
      context: ./web/AdminLTE-3_2_0-angular/adminlte-angular-app
      dockerfile: Dockerfile
    container_name: frontend-esphere-ass
    ports:
      - "8282:8080"
    depends_on:
      - gateway-proxy
    networks:
      - microservices-network
    environment:
      - NODE_ENV=production
    restart: unless-stopped

# Déclaration unique du réseau
networks:
  microservices-network:
    driver: bridge